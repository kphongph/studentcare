<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="./local/obecstudent-card.html">
<link rel="import" href="studentcare-db.html">


<!--
`studentcare-components`
Polymer Component for StudentCare project

@demo demo/index.html 
-->

<dom-module id="student-room">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        @apply(--layout-vertical);
      }

      .iron-selected {
        background: #eee;
      }

      paper-dropdown-menu {
        margin-right:20px;
      }

    </style>

    <studentcare-db 
      url="http://maas.nuqlis.com:44300"
      id="leveldb"
      remote-db="dmc59_1"
      local-db="dmc"
      view-name="hostid"
      schema='{"index":"key,value.CLASSROOM,value.LEVEL,value.CODE"}'
      query$='{"start":["{{host}}"],"end":["{{_nextHost(host)}}"],"limit":-1}'
      ready="{{_isReady}}"
      jwt-token="{{jwtToken}}">
    </studentcare-db>

    <div>
    <iron-selector id="studentSelector" on-iron-select="_studentSelected">
      <template is="dom-repeat" items="{{students}}">
        <obecstudent-card name="{{item.key}}" doc="{{item}}" 
          minimize="{{minimize}}">
        </obecstudent-card>
      </template>
    </iron-selector>
    </div>

  </template>

  <script>
    Polymer({
      is: 'student-room',
      behaviors: [
        Polymer.IronResizableBehavior
      ],
      properties: {
        host:String,
        selectedStudent: {
          type:Object,
          notify:true
        },
        minimize: {
          type:Boolean,
          readOnly:true
        },
        level:{
          type:String
        },
        room:{
          type:String
        },
        __execute:{
          type:Boolean,
          computed:'__computeStudents(level,room,_isReady)'
        },
        jwtToken:{
          type:String
        }
      },
      listeners: {
        'iron-resize':'_onIronResize'
      },
      _onIronResize:function() {
        if(this.offsetWidth < 500) {
          this._setMinimize(true);
        } else {
          this._setMinimize(false);
        }
      },
      _nextHost:function(host) {
        var next = parseInt(host)+1;
        return ''+next;
      },
      _dbName:function(host) {
        return 'dmc_'+host;
      },
      __computeStudents:function(level,room,isReady) {
        if(!isReady) return [];
        //console.log(level,room,isReady);
        this.$.studentSelector.selectIndex(-1);
        if(level && room) {
         this.$.leveldb.db.index
         .where('value.LEVEL')
         .equals(level)
         .and(function(value) {
           return value.value.CLASSROOM == room;
         })
         .toArray(function(students) {
         //  this._setStudents(students);
         //  return students;
           this.set('students',students);
         }.bind(this));
        }
      },
      _studentSelected:function(e) {
        this.set('selectedStudent',e.detail.item.doc);
      //  this.fire('select',{'student':e.detail.item.doc});
      }
    });
  </script>
</dom-module>
