<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">

<dom-module id="student-room">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        @apply(--layout-vertical);
        display: block;
      }

      .iron-selected {
        background: #eee;
      }

    </style>
    
    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>

    <iron-ajax 
      id="listAjax"
      method="POST"
      url$="https://maas.nuqlis.com:9000/api/query/{{db}}/host_level_room"
      content-type="application/json"
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}'
      last-response="{{students}}"
      body$='{"match":["{{host}}","{{level}}","{{room}}"],"limit":-1}'>
    </iron-ajax>


    <paper-listbox selected="{{student}}" 
      on-iron-select="_select"
      attr-for-selected="name">
    <template is="dom-repeat" items="{{students}}">
     <paper-item name="{{item.value}}">
      {{item.key.4.0}} {{item.key.4.2}} {{item.key.4.3}}
     </paper-item>
    </template>
    </paper-listbox>

  </template>

  <script>
    Polymer({
      is: 'student-room',
      properties: {
        host:String,
        level:String,
        room:String,
        year:String,
        db:{
          type:String,
          computed:'__computeDb(year)'
        }
      },
      observers:[
        '__execute(jwtToken,host,level,room,year)'
      ],
      __execute:function(jwtToken,host,level,room,year) {
        this.$.listAjax.generateRequest();
      },
      __computeDb:function(year) {
        var db = "dmc59_1";
        if(year == "2016") {
          db = "dmc59_1";
        }
        return db;
      },
      _select:function(e) {
        this.fire('student-selected',{'_id':this.student,'db':this.db});
      }
    });
  </script>
</dom-module>
