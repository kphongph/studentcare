<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-styles/typography.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-item/paper-icon-item.html">
<link rel="import" href="../../paper-item/paper-item-body.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../forms.html"> 

<dom-module id="assignment-card">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        @apply(--paper-font-body2);
        @apply(--layout-vertical);
        border-bottom:1px solid #efefef;
      }

      paper-item:hover {
        background:#efefef;
        cursor: pointer; 
        cursor: hand; 
      }

      .status-working {
        background:var(--paper-blue-500);
        padding:5px;
        color:#ffffff;
      }

      .status-new {
        background:var(--paper-green-500);
        padding:5px;
        color:#ffffff;
      }

      .field {
        padding-left:10px;
      }
    </style>
   
      <paper-item on-tap="_tap">
       <div class="avatar blue" item-icon></div>
       <paper-item-body two-line>
        <div>
          <span>{{_formName(data.key.5)}}</span>
        </div>   
        <div secondary>
          <span>{{_dateTime}}</span>
          <span>{{data.key.7}}</span>
          <span class$="status-{{data.key.4}}">{{_status}}</span>
        </div>
       </paper-item-body>
      </paper-item>
  </template>

  <script>
    Polymer({
      is: 'assignment-card',
      listeners: {
        'update':'_update'
      },
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        showForm: {
          type:Boolean,
          reflectToAttribute: true,
          value:false
        },
        data: {
          type:Object,
          notify:true
        },
        formElement: {
          type:Object
        },
        _dateTime: {
          type:String,
          computed:'_computeDate(data.key.8)'
        },
        _status:{
          type:String,
          computed:'_computeStatus(data.key.4)'
        }
      },
      _update:function(e) {
        var _old = this.data.key.concat();
        this.data.key[8] = e.detail.value.ts;
        this.data.key[4] = e.detail.value.status;
        var keys = this.data.key; 
        this.set('data.key',[]);
        this.set('data.key',keys);
        this.fire('assignment-update',{
          'old':{'key':_old,'value':this.data.value},
          'new':this.data
        });
      },
      _tap: function(e) {
        var eleName = this.data.key[5];
        if(eleName) {
          var ele = document.createElement(eleName);
          var doc = {'key':this.data.value};
          ele.setAttribute('document',JSON.stringify(doc));
          ele.addEventListener('update',this._update.bind(this));
          this.fire('select-assignment',{
            'formElement':ele
          });
        }
      },
      _computeDate:function(ts) {
        if(!ts) return;
        var d = new Date();
        d.setTime(ts*-1);
        var str = ("0" + d.getDate()).slice(-2) + "-" + 
          ("0"+(d.getMonth()+1)).slice(-2) + "-" +
          d.getFullYear() + " " + 
          ("0" + d.getHours()).slice(-2) + ":" + 
          ("0" + d.getMinutes()).slice(-2);
        return str;
      },
      _computeStatus: function(status) {
        var dict = {
          'new':'ใหม่',
          'working':'กำลังดำเนินการ',
          'done':'ประเมินแล้ว'
        }
        return dict[status];
      },
      attached:function() {
        this.loadResources(this.resolveUrl('../locales.json'));
      },
      _formName:function(name) {
        var ele = document.createElement(name);
        return ele.getAttribute('name');
      }
    });
  </script>
</dom-module>
