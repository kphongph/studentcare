<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-styles/typography.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-item/paper-icon-item.html">
<link rel="import" href="../../paper-item/paper-item-body.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../neon-animation/neon-animations.html">
<link rel="import" href="../../neon-animation/neon-animatable.html">
<link rel="import" href="../../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../forms.html"> 

<dom-module id="assignment-card">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        @apply(--paper-font-body2);
        @apply(--layout-vertical);
        border-bottom:1px solid #efefef;
      }

      paper-item:hover {
        background:#efefef;
        cursor: pointer; 
        cursor: hand; 
      }

      .status-working {
        background:var(--paper-blue-500);
        padding:5px;
        color:#ffffff;
      }

      .status-new {
        background:var(--paper-green-500);
        padding:5px;
        color:#ffffff;
      }

      .status-done {
        background:var(--paper-pink-500);
        padding:5px;
        color:#ffffff;
      }

      .marker-done {
        width:10px;
        background:var(--paper-pink-500);
      }

      .marker-new {
        width:10px;
        background:var(--paper-green-500);
      }

      .marker-working {
        width:10px;
        background:var(--paper-blue-500);
      }

      .field {
        padding-left:10px;
      }
    </style>
     
    <div class="layout horizontal">
    <div class$="marker-{{_info.status.type}}"></div>
    <paper-item on-tap="_tap" class="flex">
     <paper-item-body two-line>
      <neon-animatable id="formName">{{_info.form.label}}</neon-animatable>
      <div secondary>
        <span>{{_info.dateTime}}</span>
        <span>{{_info.studentName}}</span>
        <span class$="status-{{_info.status.type}}">
          {{_info.status.label}}
        </span>
      </div>
     </paper-item-body>
    </paper-item>
    </div>
  </template>

  <script>
    Polymer({
      is: 'assignment-card',
      listeners: {
        'update':'_update',
        'mouseover':'_show'
      },
      behaviors: [
        Polymer.AppLocalizeBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],
      properties: {
        showForm: {
          type:Boolean,
          reflectToAttribute: true,
          value:false
        },
        data: {
          type:Object,
          notify:true
        },
        formElement: {
          type:Object
        },
        _info : {
          type:Object,
          computed:'__computeInfo(data)'
        },
        animationConfig: {
          value:function() {
            return {
              'formNameEntry' : {
                name: 'slide-from-right-animation',
                node: this.$.formName
              },
              'detailExit' : {
                name: 'slide-from-right-animation',
                node: this.$.formName
              }
            }
          }
        }
      },
      _update:function(e) {
        var _old = this.data.key.concat();
        var keys = _old[_old.length-2];
        keys[4] = e.detail.value.ts;
        keys[0] = e.detail.value.status;
        
        this.set('data',{'key':_old,'value':this.data.value});
        /*
        this.fire('assignment-update',{
          'old':{'key':_old,'value':this.data.value},
          'new':this.data
        });
        */
      },
      _tap: function(e) {
        var ele = this._info.form.element;
        var doc = {'key':this.data.value};
        ele.setAttribute('document',JSON.stringify(doc));
        ele.addEventListener('update',this._update.bind(this));
        this.fire('select-assignment',{
          'formElement':ele
        });
      },
      attached:function() {
        this.loadResources(this.resolveUrl('../locales.json'));
      },
      __computeInfo:function(data) {
        console.log('__computeInfo');
        var tmp = {};
        if(data.key) {
          var status_dict = {
            'new':'ใหม่',
            'working':'กำลังดำเนินการ',
            'done':'ประเมินแล้ว'
          }
          var keys = data.key[data.key.length-2];
          tmp['studentName']=keys[3];
          tmp['status']={
            'label':status_dict[keys[0]],
            'type':keys[0]
          };
          var d = new Date();
          d.setTime(keys[4]*-1);
          var str = ("0" + d.getDate()).slice(-2) + "-" +
            ("0"+(d.getMonth()+1)).slice(-2) + "-" +
            d.getFullYear() + " " +
            ("0" + d.getHours()).slice(-2) + ":" +
            ("0" + d.getMinutes()).slice(-2);
          tmp['dateTime']=str;

          var ele = document.createElement(keys[1]);
          tmp['form']= {
             'label':ele.getAttribute('name'),
             'element':ele
          };
        }
        console.log(tmp);
        return tmp;
      },
      _formName:function(name) {
        var ele = document.createElement(name);
        return ele.getAttribute('name');
      },
      _show:function(e) {
       // this.playAnimation('formNameEntry');
      }
    });
  </script>
</dom-module>
