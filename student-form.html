<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="./local/assignment-card.html">
<link rel="import" href="./form-generator.html">
<link rel="import" href="./option-forms.html">

<link href="https://fonts.googleapis.com/css?family=Itim&amp;subset=thai" rel="stylesheet">

<dom-module id="student-form">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors">
       :host {
        @apply(--layout-vertical);
        --paper-progress-active-color: #d14836;
        /*สีตัวโหลด*/
        --paper-progress-indeterminate-cycle-duration: 0.8s;
        /*ระยะเวลาการโหลด*/
      }


      .iron-selected {
        background: #eee;
      }

      .control {
        padding: 5px;
      }

      .form_group {
        @apply(--paper-font-subhead);
        padding: 10px;
        background: var(--paper-grey-100);
      }

      .font-face {
        font-family: 'Itim', cursive;
        font-weight: bold;
      }
    </style>

    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>

    <iron-ajax id="getAjax" 
      method="GET" 
      url$="https://maas.nuqlis.com:8000/v2/obec/student_data_db/data/{{key}}" 
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}'
      last-response="{{student}}">
    </iron-ajax>

    <form-generator id="generator" student="{{student}}" loading="{{loading}}" 
      on-form-generated="_formGenerated" 
      on-required-form-checked="_formChecked"
      forms="{{forms}}" 
      year="{{year}}">
    </form-generator>

    <div class="horizontal layout">
      <paper-progress indeterminate hidden$="{{!loading}}" class="flex">
      </paper-progress>
    </div>

    <template is="dom-repeat" as="group" items="{{formList}}">
      <div class="form_group font-face" hidden$="{{_isEmpty(group.forms)}}">{{group.name}}</div>
      <template is="dom-repeat" items="{{group.forms}}" sort="_sortByStatus">
        <assignment-card data="{{item}}"></assignment-card>
      </template>
    </template>

    <option-forms forms="{{forms}}" student="{{student}}"></option-forms>

  </template>

  <script>
    Polymer({
      is: 'student-form',
      properties: {
        db: String,
        year: String,
        key: String,
        formList: {
          type: Array,
          notify: true,
          computed: '__generateFormList(forms)'
        }
      },
      listeners: {
        'delete-assignment':'_onAssignmentDelete',
        'form-generated':'_formGenerated'
      },
      observers: [
        '__execute(jwtToken,key)',
      ],
      __execute: function (jwtToken, key) {
        this.$.getAjax.generateRequest();
      },
      _sortByTime: function (a, b) {
        return a.key[4][1] - b.key[4][1];
      },
      _sortByStatus: function (a, b) {
        var _sort = ['new', 'working', 'done'];
        return _sort.indexOf(a.status) - _sort.indexOf(b.status);
      },
      _isEmpty:function(list) {
        return !list || list.length == 0;
      },
      _onAssignmentDelete:function(e) {
        var d_form = e.detail.form;
        console.log(d_form);
        var forms = this.forms;
        var tmp = [];
        forms.forEach(function(form) {
          if(form._id != d_form._id) {
            tmp.push(form);
          }
        });
        this.set('forms',tmp);
      },
      _formGenerated: function (e) {
        this.$.generator.reload();
      },
      _formChecked: function (e) {
        console.log(e.detail);
      },
      _reload: function (e) {
        this.$.generator.reload();
        this.set('_requiredReload', false);
      },
      __generateFormList: function(forms) {
        console.log('__generateFormList');
        var data = [];
        var group = [
          {
            'group': 'แบบคัดกรอง SDQ',
            'names': [
              'dl2-form',
              'dl3-form'
            ],
            forms: []
          },
          {
            'group': 'แบบคัดกรองนักเรียนรายบุคคล',
            'names': [
              'screening-elementary-form',
              'screening-secondary-form'
            ],
            forms: []
          },
          {
            'group': 'แบบคัดกรอง EQ',
            'names': [
              'eq-teacher-form',
              'eq-student-form'
            ],
            forms: []
          },
          {
             'group': 'แบบคัดกรองความบกพร่อง 9 ด้านของ สพฐ.',
             'names': [
               'disability-autistic-form',
               'disability-behavior-form',
               'disability-communication-form',
               'disability-health-form',
               'disability-hearing-form',
               'disability-intelligence-form',
               'disability-learning-elementary-form',
               'disability-learning-secondary-form',
               'disability-visual-form'
             ],
             'forms': []
           },
           {
             'group': 'แบบคัดกรองอื่น ๆ ',
             'names': [
               'st5-form', 'snap-form', 'suicide8q-form', 'cdi-form', 'game-form'
             ],
             forms: []
           },
        ];

        for (var i = 0; i < forms.length; i++) {
          for (var j = 0; j < group.length; j++) {
            if (group[j].names.indexOf(forms[i].form_type) != -1) {
              group[j].forms.push(forms[i]);
              break;
            }
          }
        }

        for (var i = 0; i < group.length; i++) {
          if (group[i].forms.length > 0) {
            data.push({ 'name': group[i].group, 'forms': group[i].forms });
          }
        }
        console.log(data);
        return data;
      }
    });
  </script>
</dom-module>
