<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-stepper/paper-stepper.html">
<link rel="import" href="../paper-stepper/paper-step.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../app-leveldb/app-leveldb-document.html">
<link rel="import" href="./sdq-form-choice.html">

<!--
`dl2-form`
Polymer Component for StudentCare project
-->

<dom-module id="dl2-form">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #responsiveStepper {
        --paper-stepper-horizontal;
      }
      @media (min-width:320px)  {
        #responsiveStepper {
          --paper-stepper-vertical-responsive-width: 320px;
        }
      }
    </style>      
    
    <app-leveldb
      name="test"
      url="https://maas.nuqlis.com:9000/api"
      db-name="students_care"
      app="{{app}}"
      jwt-token="{{jwtToken}}">
    </app-leveldb>
    
    <app-leveldb-query
      app="{{app}}"
      view-name="cid_year_type"
      query="{{_query}}"
      data="{{_data}}">
    </app-leveldb-query>
    
    <app-leveldb-document id="doc"
      app="{{app}}"
      key="{{docId}}"
      status="{{status}}"
      value="{{docValue}}">
    </app-leveldb-document>    

    <paper-stepper id="responsiveStepper">
      <paper-step label="หน้า 1">
        <sdq-form-choice id="formChioceId"
          form-type="{{formType}}"
          value="{{sdqChoice}}">
        </sdq-form-choice>      
      </paper-step>
      <paper-step label="หน้า 2">
        <sdq-form-teacher></sdq-form-teacher>      
      </paper-step>
    </paper-stepper>

    <!--
    <paper-button raised on-click="_completed">บันทึก</paper-button>
    <paper-button raised on-click="_newForm">ประเมินใหม่</paper-button>
    -->
    
  </template>
  <script>
    Polymer({
      is: 'dl2-form',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        dmcStudent: {
          type:Object,
          observer:'_studentChanged'
        },
        _data:{
          type:Object,
          observer:'_haveHistory'
        },
        docValue:{
          type:Object,
          notify:true,
          computed:'_DocValue(sdqChoice,dmcStudent)'
        }
      },
      _studentChanged : function(n,o){ 
        console.log(n.IDNO);
        if (n){
          var query = {
            'start': [n.IDNO,2017,'dl2form_teacher'],
            'end': [n.IDNO,2017,'dl2form_teacherxFF'],
            "limit":-1,
            'include_doc': true
          };
        this.set('_query',query);       
        }else{
          this.set('_query',{});
          this.set('_data',{});
          this.$.formChioceId.render();
        }
      },
      _haveHistory : function(n){
        console.log(n);
        if (n.length > 0){
          this.set('sdqChoice',n[0].value.doc.sdqChoice);                
        }else{
          if(this.sdqChoice){
            var self = this;
            this.sdqChoice.forEach(function(item,idx) {
              self.set('sdqChoice.'+idx+'.value',null);
            });
          }
        }         
      },
      _newForm : function(n){
      
      },
      _completed:function(e) {
        var obj = {'student':this.dmcStudent,'sdqChoice':this.sdqChoice};
        this.$.doc.save();
        this.fire('dl2-completed',obj);
      },
      _DocValue:function(sdqChoice,dmcStudent) {
        var date = new Date();
        return {'cid':dmcStudent.IDNO,'updateTime':date.getTime(),'year':date.getFullYear(),'form_type':'dl2form_teacher','sdqChoice':sdqChoice,'teacherChioce':''};
      }
    });
  </script>
</dom-module>
