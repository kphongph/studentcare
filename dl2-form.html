<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-stepper/paper-stepper.html">
<link rel="import" href="../paper-stepper/paper-step.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./local/dl-profile.html">
<link rel="import" href="./sdq-form-choice.html">
<link rel="import" href="./sdq-form-history.html">
<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../app-leveldb/app-leveldb-document.html">

<!--
`dl2-form`
Polymer Component for StudentCare project
-->

<dom-module id="dl2-form">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #visualResponsiveWidth {
        width: 500px;
        max-width: 100%;
        height: 4px;
        background: var(--primary-color);
      }
    </style>  
    <app-localstorage-document 
      key="jwtToken" 
      data="{{jwtToken}}">
    </app-localstorage-document>
    
    <app-leveldb
      name="test"
      url="https://maas.nuqlis.com:9000/api"
      db-name="students_care"
      app="{{app}}"
      jwt-token="{{jwtToken.token}}">
    </app-leveldb>
    
    <app-leveldb-document id="doc"
      app="{{app}}"
      key="{{docId}}"
      status="{{status}}"
      value="{{docValue}}">
    </app-leveldb-document>   
    
    <dl-profile 
      hidden$="{{_hideProfile}}" 
      dmc-student="{{dmcStudent}}">
    </dl-profile>

    <sdq-form-history  
      hidden$="{{_hideHistory}}" 
      dmc-student="{{dmcStudent}}" 
      on-select="__selectForm">
    </sdq-form-history> 
    
    <sdq-form-choice 
      hidden$="{{hideSdqForm}}" 
      value="{{sdqChoice}}">
    </sdq-form-choice>
    
    <paper-button hidden$="{{_hideNewFormBT}}" on-click="__newForm">ประเมินใหม่</paper-button> 
    <paper-button hidden$="{{_hideSaveBT}}" raised on-click="__completed">บันทึก</paper-button>
    
  </template>
  <script>
    Polymer({
      is: 'dl2-form',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        _hideProfile: {
          type:Boolean,
          value:true
        },
        _hideHistory: {
          type:Boolean,
          value:true
        },
        _hideNewFormBT: {
          type:Boolean,
          value:true
        },
        _hideSaveBT: {
          type:Boolean,
          value:true
        },
        dmcStudent: {
          type:Object,
          observer:'_studentChanged'
        },
        hideSdqForm:{
          type:Boolean,
          value:true
        },
        docValue:{
          type:Object,
          notify:true,
          computed:'__DocValue(sdqChoice,dmcStudent)'
        }
      },
      _studentChanged:function() {
        if(this.dmcStudent) {
          this.set('_hideProfile',false);
          this.set('_hideNewFormBT',false);
          this.set('_hideHistory',false);
          this.set('hideSdqForm',true);
          this.set('_hideSaveBT',true);
        }
      },
      __selectForm:function(e) {                
        console.log('_selectForm');
      },
      __newForm:function(e){      
        this.set('_hideProfile',false);
        this.set('hideSdqForm',false);
        this.set('_hideHistory',true); 
        this.set('_hideNewFormBT',true);
        this.set('_hideSaveBT',false); 
      },
      __completed:function(e) {
        var obj = {'student':this.dmcStudent,'sdqChoice':this.sdqChoice};
        this.$.doc.save();
        this.fire('dl2-completed',obj);
      },
      __DocValue:function(sdqChoice,dmcStudent) {
        var date = new Date();
        return {'cid':dmcStudent.IDNO,'updateTime':date.getTime(),'year':date.getFullYear(),'sdqChoice':sdqChoice};
      }
    });
  </script>
</dom-module>
