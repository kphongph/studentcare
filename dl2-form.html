<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-stepper/paper-stepper.html">
<link rel="import" href="../paper-stepper/paper-step.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./local/dl-profile.html">
<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../app-leveldb/app-leveldb-document.html">

<!--
`dl2-form`
Polymer Component for StudentCare project

@demo demo/dl2-form.html
-->

<dom-module id="dl2-form">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #visualResponsiveWidth {
        width: 500px;
        max-width: 100%;
        height: 4px;
        background: var(--primary-color);
      }
    </style>

    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>
    
    <app-leveldb
      name="test"
      url="https://maas.nuqlis.com:9000/api"
      db-name="students_care"
      app="{{app}}"
      jwt-token="{{jwtToken.token}}">
    </app-leveldb>
    
    <app-leveldb-query
      app="{{app}}"
      view-name="cid_date"
      query="{{_query}}"
      data="{{_data}}">
    </app-leveldb-query>
    
    <app-leveldb-document id="doc"
      app="{{app}}"
      key="{{docId}}"
      status="{{status}}"
      value="{{docValue}}">
    </app-leveldb-document>
    
    <dl-profile hidden$="{{_hideForm}}" dmc-student="{{dmcStudent}}"></dl-profile>     
    <template is="dom-if" if="{{_hasHistory}}">
      <h2>ประวัติการประเมิน SDQ</h2>
      <template is="dom-repeat" items="{{_data}}">    
        <div role="listbox">
         <paper-item>
            <sdq-form-choice value="{{item.value.doc.sdqChoice}}"></sdq-form-choice>            
         </paper-item>
        </div>        
      </template>  
      <paper-button raised on-click="_completed">บันทึก</paper-button>        
    </template>

     <template is="dom-if" if="{{!_hasHistory}}">      
      <sdq-form-choice hidden$="{{hideChoice}}" value="{{sdqChoice}}"></sdq-form-choice>
      <paper-button hidden$="{{hideChoice}}" raised on-click="_completed">บันทึก</paper-button>        
    </template> 
    <paper-button hidden$="{{_hideForm}}" raised on-click="_newForm">ทำแบบประเมินใหม่</paper-button>    

  </template>

  <script>
    Polymer({
      is: 'dl2-form',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        dmcStudent: {
          type: Object,
          observer: '_hideChoice'
        },
        _hideForm: {
          type: Boolean,
          value: true 
        },
        hideChoice: {
          type: Boolean,
          value: true 
        },
        sdqChoice: {
          type: Object,
          notify: true
        },
        _query: {
          type: Object,
          computed: '_studentChanged(dmcStudent)'
        },
        _hasHistory: {
          type: Boolean,
          computed: '_checkHasHistory(_data)'
        },
        docValue:{
          type:Object,
          notify:true,
          computed:'__computeDocValue(sdqChoice,dmcStudent)'
        },
        docId: String,
      },
      _studentChanged : function(studentData){
        if (!studentData) return;
        return {
          'start': [studentData.IDNO],
          'end': ['' + (Number(studentData.IDNO) + 1)],
          'include_doc': true
        };
      },
      _checkHasHistory: function(obj) {
        if (obj.length == 0){ 
          return false;
        }else{
          this.hideChoice = false;
          return true;
        }        
      },
      _newForm: function(){
        this.hideChoice = !this.hideChoice;
      },
      __computeDocValue:function(sdqChoice,dmcStudent) {
          var objSave = {
            'cid':dmcStudent.IDNO,
            'updateTime':new Date().getTime(),
            'sdqChoice':sdqChoice
          } 
        return objSave;
      },
      _completed:function(e) {
        var obj = {'student':this.dmcStudent,'sdqChoice':this.sdqChoice};
        this.$.doc.save();
        this.fire('dl2-completed',obj); 
      },
      _hideChoice: function(n,o){
        this.hideChoice = true;
        this._hideForm = false;
      }
    });
  </script>
</dom-module>
