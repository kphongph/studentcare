<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<!--
<link rel="import" href="../paper-stepper/paper-stepper.html">
<link rel="import" href="../paper-stepper/paper-step.html">
-->
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../app-leveldb/app-leveldb-document.html">
<link rel="import" href="./sdq-form-choice.html">
<link rel="import" href="./sdq-form-teacher.html">

<!--
`dl2-form`
Polymer Component for StudentCare project
-->

<dom-module id="dl2-form">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #responsiveStepper {
        --paper-stepper-vertical-responsive-width: 400px;
      }
      paper-step {
        --paper-vertical-step-max-height: 600px;
      }

      @media (min-width:320px) {
        #responsiveStepper {
          --paper-stepper-horizontal;
          --paper-stepper-horizontal-opened-height: 1000px;
        }
        #toastsave{
          --paper-toast-background-color: green;
          --paper-toast-color: white;
            bottom: 0;
            left: 0;
            height: 20px;
            width: 100%;
        }
      }
    </style>     
    <app-localstorage-document 
      key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>
    
    <app-leveldb
      name="test"
      url="https://maas.nuqlis.com:9000/api"
      db-name="students_care"
      app="{{app}}"
      jwt-token="{{jwtToken.token}}">
    </app-leveldb>
    
    <app-leveldb-query
      app="{{app}}"
      view-name="cid_year_type"
      query="{{_query}}"
      data="{{_data}}">
    </app-leveldb-query>
    
    <app-leveldb-document id="doc"
      app="{{app}}"
      key="{{_docId}}"
      status="{{status}}"
      value="{{_docValue}}">
    </app-leveldb-document>    

    <paper-button raised on-click="test">test</paper-button>
    <paper-stepper id="responsiveStepper"       
      on-paper-stepper-completed="_completed"
      horizontal-higher-entry-animation="scale-up-animation"        
      horizontal-lower-entry-animation="scale-up-animation"       
      horizontal-higher-exit-animation="scale-down-animation" 
      horizontal-lower-exit-animation="scale-down-animation">
      <paper-step id="formChoice" label="หน้า 1"  editable>
        <sdq-form-choice id="formChoiceId"
          form-type="{{_formTitle}}"
          value="{{sdqChoice}}">
        </sdq-form-choice>      
      </paper-step>
      <paper-step label="หน้า 2" editable on-paper-step-updated="_completed">
        <sdq-form-teacher>
        </sdq-form-teacher>      
      </paper-step>
    </paper-stepper>
    <paper-toast id="toastsave"></paper-toast>
    <paper-button on-tap="_completed" raised>Save</paper-button>
  </template>
  <script>
    Polymer({
      is: 'dl2-form',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        _formTitle: {
          type:Object,
          computed:'_formTypeDit(formType)'
        },
        dmcStudent: {
          type:Object,
          observer:'_studentChanged'
        },
        _data:{
          type:Object,
          observer:'_haveHistory'
        },
        _docValue:{
          type:Object,
          notify:true,
          computed:'_computedDocValue(sdqChoice,dmcStudent)'
        },
        _docId:{
          type:String
        }
      },
      ready:function() {
        var step1 = this.$.formChoice;
        var self = this;
        step1._getValidity = function() {
          return self.$.formChoiceId.validate();
        }
      },
      test:function() {
          this.$.toastsave.customStyle['--paper-toast-background-color'] = 'red';
          this.$.toastsave.updateStyles();
          this.$.toastsave.show('กรุณาเลือกนักเรียนก่อน');
      },
      _studentChanged : function(n,o){
        if (n){
          var year = new Date().getFullYear();
          var query = {
            'match': [n.IDNO,year,'dl2form_teacher'],
            "limit":-1,
            'include_doc': true
          };                   
          this.set('_query',query);
        }else{
          this.set('_query',{});
          this.set('_data',{});
          this.$.formChoiceId.render();          
        }
      },
      _haveHistory : function(n){
        console.log('_haveHistory',n);
        if (n.length > 0){
          this.set('_docId',n[0].value.key);
          this.set('sdqChoice',n[0].value.doc.sdqChoice);
        }else{
          this.set('_docId',null);
          if(this.sdqChoice){
            var self = this;            
            this.sdqChoice.forEach(function(item,idx) {              
              self.set('sdqChoice.'+idx+'.value',null);
            });
          }
        }
      },
      _completed:function(e) {
        var valid = this.$.formChoiceId.validate();
        if(valid && this.dmcStudent){
          var date = new Date();
          var objSave = {
            'cid':this.dmcStudent.IDNO,
            'updateTime':date.getTime(),
            'year':date.getFullYear(),
            'form_type':this.formType,
            'form_type_desc':this._formTitle,
            'sdqChoice':this.sdqChoice,
            'teacherChioce':''
          };
          console.log(this._docId);
          this.$.doc.save();
          this.$.responsiveStepper.reset();
          this.$.toastsave.customStyle['--paper-toast-background-color'] = 'green';
          this.$.toastsave.updateStyles();
          this.$.toastsave.show('บันทึกสำเร็จ');
          this.fire('dl2-completed',objSave);      
        }else{
          this.$.responsiveStepper.reset();
          this.$.toastsave.customStyle['--paper-toast-background-color'] = 'red';
          this.$.toastsave.updateStyles();
          this.$.toastsave.show('กรุณาเลือกนักเรียนก่อน');
        }        
      },
      _computedDocValue:function(sdqChoice,dmcStudent) {
        var date = new Date();
        var objSave = {
          'cid':dmcStudent.IDNO,
          'updateTime':date.getTime(),
          'year':date.getFullYear(),
          'form_type':this.formType,
          'form_type_desc':this._formTitle,
          'sdqChoice':sdqChoice,
          'teacherChioce':''
        };
        return objSave;
      },
      _formTypeDit:function(formType){
        var formTypeDit = {"dl2form_teacher":"แบบประเมินพฤติกรรมเด็ก (SDQ) ฉบับครูเป็นผู้ประเมินนักเรียน"};
        return formTypeDit[formType];
      }
    });
  </script>
</dom-module>
