<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">

<!--
`studentcare-components`
Polymer Component for StudentCare project

@demo demo/index.html 
-->

<dom-module id="student-table">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <b>Total</b>
    <span>{{status.total}}</span>
    <b>Sync</b>
    <span>{{status.sync}}</span>
    <b>Host</b>
    <span>{{host}}</span>

    <iron-ajax 
      method="POST"
      url="https://maas.nuqlis.com:9000/api/query/obec_students/host_class_room"
      params='{"apikey":"125856d0eb2711e690184b0ac3cc96bd"}'
      body="{{_query(host)}}"
      handle-as="json"
      last-response="{{view}}"
      content-type="application/json"
      auto>
    </iron-ajax>

    <app-leveldb
       id="leveldb"
       url="https://maas.nuqlis.com:9000/api/dbs/obec_students"
       api-key="125856d0eb2711e690184b0ac3cc96bd"
       db-name="{{_dbName(host)}}"
       schema='{"index":"key,value.class,value.room,value.cid,value.name,value.lastname"}'
       data="{{view}}"
       on-ready="_dbReady"
       status="{{status}}">
    </app-leveldb>
    
    <paper-dropdown-menu label="ระดับชั้น" on-iron-select="_classSelected">
     <paper-listbox class="dropdown-content">
      <template is="dom-repeat" items="{{classes}}">
        <paper-item>{{item}}</paper-item>
      </template>
     </paper-listbox>
    </paper-dropdown-menu>

    <paper-dropdown-menu label="ห้อง" on-iron-select="_roomSelected">
     <paper-listbox class="dropdown-content">
      <template is="dom-repeat" items="{{rooms}}">
        <paper-item>{{item}}</paper-item>
      </template>
     </paper-listbox>
    </paper-dropdown-menu>


    <template is="dom-repeat" items="{{students}}">
      <p>
        <span>{{item.value.cid}}</span> 
        <span>{{item.value.name}}</span> 
        <span>{{item.value.lastname}}</span> 
        <span>{{item.value.class}}</span> 
        <span>{{item.value.room}}</span> 
      </p>
    </template>

  </template>

  <script>
    Polymer({
      is: 'student-table',
      properties: {
        host:String,
        selectedClass:String,
        selectedRoom:String
      },
      observers: [
        '_filter(selectedClass,selectedRoom)'
      ],
      _dbReady:function() {
        this.$.leveldb.db.index
         .orderBy('value.class')
         .uniqueKeys(function(classes) {
           this.set('classes',classes);
        }.bind(this));
      },
      _dbName:function(host) {
        return 'obec_students_'+host;
      },
      _query:function(host) {
        var end = ""+(parseInt(host)+1);
        return {'start':[host],'end':[end],limit:-1};
      },
      _classSelected:function(e) {
        var selectedItem = e.target.selectedItem;
        if(selectedItem) {
          var target = selectedItem.innerText;
          this.set('selectedClass',target);

          this.$.leveldb.db.index
           .orderBy('value.room')
           .filter(function(obj) {
             return obj.value.class = target;
           }) 
           .uniqueKeys(function(objs) {
             this.set('rooms',objs);
          }.bind(this));

          /*
          this.$.leveldb.db.index
           .where('value.class')
           .equals(target)
           .toArray(function(students) {
             this.set('students',students);
           }.bind(this));
          */
        }
      },
      _roomSelected:function(e) {
        var selectedItem = e.target.selectedItem;
        if(selectedItem) {
          var target = selectedItem.innerText;
          this.set('selectedRoom',target);
        }
      },
      _filter:function(selectedClass,selectedRoom) {
        if(selectedClass && selectedRoom) {
         this.$.leveldb.db.index
         .where('value.class')
         .equals(selectedClass)
         .and(function(value) {
           return value.value.room == selectedRoom;
         })
         .toArray(function(students) {
           this.set('students',students);
         }.bind(this));
        }
      }
    });
  </script>
</dom-module>
