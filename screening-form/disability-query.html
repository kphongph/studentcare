<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../app-storage/app-localstorage/app-localstorage-document.html">

<dom-module id="disability-query">
 <template>

   <app-localstorage-document
     key="jwtToken"
     data="{{jwtToken}}">
   </app-localstorage-document>

   <iron-ajax
     id="listDisability"
     url="https://maas.nuqlis.com:8000/v2/obec/students_care/query"
     method="POST"
     headers$='{"Authorization":"JWT {{jwtToken.token}}"}'
     content-type="application/json"
     body$='{"query":{"doc_type":"assignment","student.cid":"{{cid}}","dmc.year":"{{year}}"}}'
     on-response="handleResponse">
   </iron-ajax>

 </template>
 <script>
  Polymer({
    is:"disability-query",
    properties:{
      cid:{
        type:String,
        notify:true,
        reflectToAttribute:true
      },
      year:{
        type:String,
        notify:true,
        reflectToAttribute:true
      },
      document: {
        type:Array,
        notify:true
      },
      isVisual:{
        type:Boolean,
        notify:true,
        reflectToAttribute:true,
        computed:'__computedIsVisual(document)'
      },
      isHearing:{
        type:Boolean,
        notify:true,
        reflectToAttribute:true,
        computed:'__computedIsHearing(document)'
      },
      isHealth:{
        type:Boolean,
        notify:true,
        reflectToAttribute:true,
        computed:'__computedIsHealth(document)'
      }
    },
    observers:[
      'executeQuery(jwtToken.token,cid,year)'
    ],
    executeQuery:function(token,cid,year) {
      //console.log(token,cid,year);
      if(!token || !cid || !year) return;
      this.$.listDisability.generateRequest();
    },
    handleResponse:function(e) {
      var res = e.detail.response;
      if(res.length == 0) return;
      var _document = [];
      for(var i=0;i<res.length;i++){
        if((/^disability/i).test(res[i].form_type)) {
          //console.log(res[i].form_type);
          _document.push(res[i]);
        }
      }
      //console.log(_document);
      this.set('document',_document);
    },
     __computedIsVisual(visual) {
       if(visual.length == 0) return;
       for(var i=0;i<visual.length;i++){
         if(visual[i].form_type=="disability-visual-form") {
           if(!visual[i].form_result._risk) {
             return false;
           }else{
             return true;
           }
         }
       }
     },
     __computedIsHearing(hearing) {
       //console.log('hearing',hearing);
       if(hearing.length == 0) return;
       for(var i=0;i<hearing.length;i++){
         if(hearing[i].form_type=="disability-hearing-form") {
           if(!hearing[i].form_result._risk){
             return false;
           }else{
             return true;
           }
         }
       }
     },
     __computedIsHealth(health) {
       //console.log('health',health);
       if(health.length == 0) return;
       for(var i=0;i<health.length;i++){
         if(health[i].form_type=="disability-health-form") {
           if(!health[i].form_result._risk){
             return false;
           }else{
             return true;
           }
         }
       }
     },
  });
 </script>
</dom-module>
