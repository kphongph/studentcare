<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="local/assignment-card.html">
<link rel="import" href="leveldb-query.html">

<dom-module id="assignment-panel">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        --paper-item-min-height:40px;
      }
    </style>

    <leveldb-query url="https://maas.nuqlis.com:9000/api"
      db-name="students_care"
      view-name="assignment"
      data="{{data}}"
      query="{{query}}">
    </leveldb-query>
    <div class="layout horizontal">
      <paper-listbox selected="{{_type}}" attr-for-selected="name" 
        class="flex-1">
        <paper-item name="new">
          ใหม่ (<span>{{_newCount}}</span>)
        </paper-item>
        <paper-item name="working">
          กำลังดำเนินการ (<span>{{_workingCount}}</span>)
        </paper-item>
        <paper-item name="done">
          ประเมินแล้ว (<span>{{_doneCount}}</span>)
        </paper-item>
      </paper-listbox>

      <paper-material elevation="1" class="flex-4">
        <template is="dom-repeat" items="{{data}}"> 
          <assignment-card data="{{item}}"
            on-select-assignment="_onSelect">
          </assignment-card>  
        </template>
      </paper-material>
   </div>

  </template>

  <script>
    Polymer({
      is: 'assignment-panel',
      listeners:{
        'assignment-update':'_onAssignmentUpdate'
      },
      properties: {
        selectedStudent: {
          type:Object,
          notify:true
        },
        host: {
          type:String
        },
        level:{
          type:String
        },
        room:{
          type:String
        },
        page: {
          type:Number,
          readOnly:true,
          value:0
        },
        query:{
          type:Object,
          computed:'__computeQuery(host,level,room)'
        }
      },
      observers:[
        '_onDataChanged(data)',
        '_onTypeChanged(_type)'
      ],
      __computeQuery:function(host,level,room) {
        return {"match":[host,level,room],"limit":-1};
      },
      _onAssignmentUpdate:function(e) {
        var self = this;
        this.data.forEach(function(item,idx) {
          if(item.value == e.target.data.value) {
            console.log(idx,e.target.data);
            var tmp = self.data;
            tmp[idx]=e.target.data;
            self.set('data',[]);
            self.set('data',tmp);
          }
        });
      },
      _onDataChanged:function(data) {
        this._updateStatus(data);
      },
      _updateStatus:function(data) {
        var dict = {
          'working':0,
          'new':0,
          'done':0
        };
        data.forEach(function(item) {
          if(dict[item.key[4]] >=0 ) dict[item.key[4]]++;
        });
        for(var key in dict) {
          this.set('_'+key+'Count',dict[key]);
        }
      },
      filterByType:function(str) {
        return function(a) {
          return a.key[4] == str;
        }
      },
      _onSelect:function(e) { 
        var self = this;
        var show=e.target.showForm;
        var _type=e.target.data.key[4];
        var key =e.target.data.value;
        var eles =Polymer.dom(this.root)
         .querySelectorAll('assignment-card');
        eles.forEach(function(ele) {
          if(ele.data.value != key)  {
             if(!show) {
               if(!self._type) {
                 ele.hidden=show;
               } else {
                 if(ele.data.key[4] == self._type) {
                   ele.hidden=show;
                 }
               }
             } else {
               ele.hidden=show;
             }
          }
        });
      },
      _onTypeChanged:function(_type) {
        console.log(_type);
        var eles =Polymer.dom(this.root)
         .querySelectorAll('assignment-card');
        eles.forEach(function(ele) {
          if(_type != ele.data.key[4]) {
            ele.hidden=true;
            ele.showForm=false;
          } else {
            ele.hidden=false;
          }
        });
      }
    });
  </script>
</dom-module>
