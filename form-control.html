<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../app-layout/app-layout.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../app-leveldb/app-leveldb.html">
<link rel="import" href="../app-leveldb/app-leveldb-document.html">

<link href="https://fonts.googleapis.com/css?family=Itim&amp;subset=thai" rel="stylesheet">

<script src="../kjur-jsrsasign/jsrsasign-all-min.js"></script>

<dom-module id="form-control">
  <template>
    <style include="iron-flex iron-flex-alignment">
      paper-tabs {
        background-color: var(--paper-grey-50);
        color: #F44336;
        height: 40px;
      }

       :host {
        --paper-tab-ink: var(--paper-grey-500);/* สีเอฟเฟคตอนกดปุ่ม */
      }

      paper-tabs {
        --paper-tabs-selection-bar-color: #F44336;/*var(--paper-grey-500); /* สีของ tab ที่เลือก */
      }

      paper-button {
        margin-left: 10px;
        margin-right: 10px;
        padding: 5px;
      }

      .student-info {
        padding: 10px;
      }

      .formControl {
        padding: 5px;
      }

      .font-face {
        font-family: 'Itim', cursive;
      } 
      .font-face-status {
        font-family: 'Itim', cursive;
         font-size: 20px;
         font-weight: bold;
      } 
      .font-face-big {
        font-family: 'Itim', cursive;
        font-size: 17px;
         text-decoration: underline;
      }
            .font-face-big-bold {
        font-family: 'Itim', cursive;
        font-size: 17px;
        font-weight: bold;
         /*text-decoration: underline;*/
       
      }
    </style>
    <custom-style>
      <style is="custom-style">
        paper-button.giant-cal {
          --paper-icon-button-ink-color: var(--paper-orange-500);
          background-color: var(--paper-light-blue-500);
          color: white;
          border-radius: 3px;
          padding: 2px;
          width: 100px;
          height: 100px;
          }
          paper-button.giant-new {
          --paper-icon-button-ink-color: var(--paper-orange-500);
          background-color:#ff8000;
          color: white;
          border-radius: 3px;
          padding: 2px;
          width: 100px;
          height: 100px;
          }
          paper-button.giant-abc {
          --paper-icon-button-ink-color: var(--paper-orange-500);
          background-color:#9ACD32;
          color: white;
          border-radius: 3px;
          padding: 2px;
          width: 100px;
          height: 100px;
          }
  
      </style>
    </custom-style>

    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>

    <app-leveldb name="test" url="https://maas.nuqlis.com:9000/api" db-name="students_care" app="{{app}}" jwt-token="{{jwtToken.token}}">
    </app-leveldb>

    <app-leveldb-document id="doc" app="{{app}}" key="{{docKey}}" on-response="_onResponse" status="{{status}}" value="{{docValue}}">
    </app-leveldb-document>

    <div class="student-info">
      <span class="font-face-big-bold"> เลขประจำตัวประชาชน  &nbsp;&nbsp;</span>
      <span class="font-face-big">{{docValue.student.cid}}</span>
      <span class="font-face-big-bold">&nbsp;&nbsp;&nbsp;ชื่อ - นามสกุล &nbsp;&nbsp;</span>
      <span class="font-face-big">{{docValue.student.name}}</span>
    </div>

    <paper-tabs selected="{{page}}">
      <paper-tab>
        <div class="font-face-big-bold">คำชี้แจง</div>
      </paper-tab>
      <paper-tab>
        <div class="font-face-big-bold">แบบประเมิน</div>
      </paper-tab>
      <paper-tab>
        <div class="font-face-big-bold">ผลการประเมิน</div>
      </paper-tab>
    </paper-tabs>

    <iron-pages selected="{{page}}">
      <content select=".description"></content>

      <div class="layout vertical">
         <content select=".formEntry"></content>

        <div class="layout horizontal formControl center-justified">

          <paper-button raised class="giant-new" on-tap="_undo">
            <iron-icon icon="settings-backup-restore"></iron-icon>
            <div class="font-face-big-bold">เริ่มใหม่</div>
          </paper-button>
          <paper-button raised class="giant-cal" on-tap="_process">
            <iron-icon icon="search"></iron-icon>
            <div class="font-face-big-bold">ประเมิน</div>
          </paper-button>
          <paper-button raised class="giant-abc" on-tap="_onSave">
            <iron-icon icon="save"></iron-icon>
            <div class="font-face-big-bold">บันทึก</div>
          </paper-button>
        </div>

        <center>
        <div class="font-face-status">{{message}}</div>
       </center>

      </div>
      <div>
        <content select=".evaluation"></content>
      </div>
    </iron-pages>

  </template>
  <script>
    Polymer({
      is: 'form-control',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        docKey: {
          type: String
        },
        docValue: {
          type: Object,
          notify: true
        },
        page: {
          type: Number,
          value: 0
        }
      },
      _onSave: function (e) {
        console.log('_save');
        this.fire('form-action', { 'type': 'save' });
      },
      _undo: function (e) {
        this.fire('form-action', { 'type': 'undo' });
      },
      _process: function (e) {
        this.fire('form-action', { 'type': 'process' });
      },
      _onResponse: function (e) {
        console.log('_onResponse');
        var self = this;
        if (!this.$.doc.error) {
          this.set('message', 'บันทึกเรียบร้อย');
          this.fire('update', { 'key': this.docKey, 'value': this.docValue });
          setTimeout(function () {
            self.set('message', '');
          }, 2000);
        }
      },
      save: function (e) {
        if (!this.docKey) {
          this.set('docKey', null);
        }
        var ele = document.createElement('iron-request');
        var self = this;
        ele.send({
          url: "https://maas.nuqlis.com:9001/servertime",
          method: "GET"
        }).then(function (res) {
          var ts = Number(res.response) * -1;
          var a = self.jwtToken.token.split(".");
          var uClaim = b64utos(a[1]);
          var pClaim = KJUR.jws.JWS.readSafeJSONString(uClaim);
          self.docValue.user_id = pClaim.UserID;
          self.docValue.ts = ts;
          if (!self.$.doc.error) {
            self.$.doc.save();
          }
        });
      }
    });
  </script>
</dom-module>