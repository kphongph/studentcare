<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../app-layout/app-layout.html">
<link rel="import" href="../../paper-styles/color.html">
<link rel="import" href="../../paper-styles/typography.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-progress/paper-progress.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../neon-animation/web-animations.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../forms.html">
<link rel="import" href="form-link.html">


<link href="https://fonts.googleapis.com/css?family=Athiti" rel="stylesheet">

<dom-module id="report-room">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
       :host {
        @apply (--layout-vertical);
      }
      
      .container {
        @apply (--layout-horizontal);
        @apply (--layout-center-justified);
      }
      .form_group {
        @apply (--paper-font-subhead);
        padding: 10px;
        background: var(--paper-grey-100);
      }
      .content{
        background :white;
      }
      .header {
        font-family: 'Athiti', sans-serif;
        font-size: 25px;
        font-weight: bold;
      }
      .header2 {
        @apply (--layout-center-justified);
        font-family: 'Athiti', sans-serif;
        /* font-size: 25px; */
        /* font-weight: bold; */
        
      }
      .note{
        border:2px solid #44ada8;
        font-family: 'Athiti', sans-serif;
        background: #fff;
        color: #000;
      }

      iron-icon {
        width: 40px;
        height: 40px;
      }
      .marker-new {
        width: 5px;
        height: 30px;
        background:#000000;
      }

      .marker-working {
        width: 5px;
        height: 30px;
        background:#FF0000;
      }

      .row-content {
        padding-top:10px;
        padding-bottom:10px;
        border-bottom:1px solid #efefef;
      }

      .layout-note {
        @apply --layout-horizontal;
        margin-bottom: 5px;
      }
      .font-face {
         @apply --paper-font-subhead;
        font-family: 'Athiti', sans-serif;
        font-size: 18px;
      }
      app-toolbar {
        background-color: #e65540;
        color: white; 
      }
    </style>

    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>

      
    <iron-ajax id="getAjax" 
      method="GET" 
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}' 
      url$="https://maas.nuqlis.com:8000/v2/obec/_studentcare_report/data/students_{{year}}_{{hostid}}_{{level}}_{{room}}" 
      content-type="application/json"
      handle-as ="json"
      on-response="handleResponse">
    </iron-ajax>

    <app-toolbar>
      <paper-icon-button icon="arrow-back" on-tap="_back" hidden$="{{isFirstPage(page)}}">
      </paper-icon-button>
      <div class="font-face">รายงานนักเรียนโรงเรียน {{hostid}}</div>
      <div class="font-face">ข้อมูล ณ วันที่ {{ts}}</div>
    </app-toolbar>
    
    <iron-ajax id="listLevel" 
      method="POST" 
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}' 
      url="https://maas.nuqlis.com:8000/v2/obec/student_data_db/query"
      content-type="application/json" 
      handle-as="json" 
      body='{"query":{"hostid":"{{hostid}}"},"distinct":"class"}'
      last-response="{{levelList}}">
    </iron-ajax>

    <iron-ajax id="listRoom" 
      method="POST" 
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}' 
      url="https://maas.nuqlis.com:8000/v2/obec/student_data_db/query"
      content-type="application/json" 
      handle-as="json" 
      body='{"query":{"hostid":"{{hostid}}","class":"{{level}}"},"distinct":"room"}'
      last-response="{{roomList}}">
    </iron-ajax>

    <iron-pages selected="{{page}}" fallback-selection="0">
     <div class="layout vertical">
      <div class="layout horizontal">
       <paper-dropdown-menu label="ระดับชั้น">
        <paper-listbox slot="dropdown-content" 
          attr-for-selected="name"
          selected="{{level}}">
         <template is="dom-repeat" items="{{levelList}}">
          <paper-item name="{{item}}">{{item}}</paper-item>
         </template>
        </paper-listbox>
       </paper-dropdown-menu>

       <paper-dropdown-menu label="ห้อง">
        <paper-listbox slot="dropdown-content" 
          attr-for-selected="name"
          selected="{{room}}">
         <template is="dom-repeat" items="{{roomList}}">
          <paper-item name="{{item}}">{{item}}</paper-item>
         </template>
        </paper-listbox>
       </paper-dropdown-menu>
      </div>
     
      <div class="layout horizontal">
        <div class="flex-2 font-face form_group">ชื่อ-นามสกุล</div>
        <div class="flex-2 font-face form_group">SDQ</div>
        <div class="flex-2 font-face form_group">EQ</div>
        <div class="flex-2 font-face form_group">เด็กพิการ 9 ด้าน</div>
        <div class="flex-2 font-face form_group">นักเรียนรายบุคคล</div>
        <div class="flex-2 font-face form_group">อื่นๆ</div>
      </div>

      <template is="dom-repeat" as="row" items="[[list]]">
        <div class="layout horizontal row-content center">
          <template is="dom-repeat" as="col" items="[[row]]">
            <div class="flex-2 layout vertical">
              <template is="dom-repeat" items="[[col]]">
                <template is="dom-if" if="{{_doc(item)}}">
                  <form-link message="{{item.mesg}}" doc-id="{{item.doc}}">
                  </form-link>
                </template>
                <template is="dom-if" if="{{!_doc(item)}}">
                  <div class="font-face">{{item}}</div> 
                </template>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>
    <div id="formEntry">
    </div>
  </iron-pages>

  </template>
  
  <script>
    Polymer({
      is: "report-room",
      properties:{
        hostid:{
          type:String,
          notify:true
        },
        level:{
          type:String,
          notify:true
        },
        room:{
          type:String,
          notify:true
        },
        year:{
          type:String,
          notify:true
        },
        list: {
          type:Array,
          notify:true,
          value:function() {
              return [];
          }
        }   
      },
      observers:[
        '_execute(jwtToken.token,hostid)',
        '_queryRoom(jwtToken.token,year,hostid,level,room)'
      ],
      listeners:{
        'form-linked':'_formSelected'
      },
      isFirstPage:function(page) {
        return page == 0;
      },
      _back:function() {
        this.set('page',this.page - 1);
      },
      _formSelected:function(e) {
        var node = this.$.formEntry;
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
        this.set('page',1);
        this.$.formEntry.appendChild(e.detail.form);
      },
      _execute(token,hostid) {
        if(!token || !hostid) return;  
        this.$.listLevel.generateRequest();
      },
      _queryRoom(token,year,host,level,room) {
        if(!token || !year || !host) return;
        if(level!=null) {
          this.$.listRoom.generateRequest();
          if(room!=null) {
            this.$.getAjax.generateRequest();
          }
        } 
      },
      _doc:function(item) {
        return item.hasOwnProperty('doc');
      },
      _select:function(e) {
        console.log(e.detail);
      },
      handleResponse(e) {
        var doc = e.detail.response;
        var student ={};
        var content = doc.value;
        var list = [];
        var arr_index = [
          ['name'],
          ['dl2-form'],
          [],
          ['disability-intelligence-form'],
          [],
          ['game-form']
        ];
        var message_dict = {
          'dl2-form':['เสี่ยง','ไม่เสี่ยง'],
          'game-form':['ติดเกม','ไม่ติดเกม'],
          'disability-intelligence-form':['เสี่ยงด้านความเรียนรู้']
        };
        for(var cid in content) {
          var row = [];
          for(var i=0;i<arr_index.length;i++) {
            row.push([]);
          }
          var student = content[cid];
          for(var attr in content[cid]) {
            var col = -1;
            for(var i=0;i<arr_index.length;i++) {
              if(arr_index[i].indexOf(attr)!=-1) {
                col = i;
                break;
              }
            }
            if(col!=-1) {
              if(content[cid][attr].doc) {
                var mesg = message_dict[attr];
                content[cid][attr]['mesg']=mesg;
                if(content[cid][attr].risk) {
                  content[cid][attr]['mesg']=mesg[0];
                } else {
                  if(mesg[1]) {
                    content[cid][attr]['mesg']=mesg[1];
                  }
                }
                row[col].push(content[cid][attr]);
              } else {
                row[col].push(content[cid][attr]);
              }
            }
          }
          list.push(row);
        }
        this.set('list',list);
      }
    });
    
  </script>
</dom-module>
