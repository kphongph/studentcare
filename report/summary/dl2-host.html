<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../summary-report-behavior.html">
<link rel="import" href="../../../iron-ajax/iron-ajax.html">
<link href="https://fonts.googleapis.com/css?family=Athiti" rel="stylesheet">

<dom-module id="dl2-host">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
       :host {
        background-color: white;
      }

      paper-tabs {
        background: #20acbb;
        color: white;
        height: 40px;
      }

      .font-face {
        font-family: 'Athiti', sans-serif;
        font-size: 100%;
      }

      #title {
        --paper-input-container-input: {
          /*font-size: 24px;*/
          font-family: 'Athiti', sans-serif;
        }
        ;
        --paper-input-container-label: {
          font-family: 'Athiti', sans-serif;
        }
        ;

        /*--paper-input-container-color:red;*/
        --paper-input-container-focus-color:#e94a60;

        /*--paper-input-container-input-color:var blue;*/
      }

      .row-content {
        border-bottom: 1px solid #443F3F;
        /* border-left:1px solid #443F3F; */
        padding-bottom: 5px;
        padding-top: 5px;
      }
    </style>

    <app-localstorage-document key="jwtToken" data="{{jwtToken}}">
    </app-localstorage-document>

    <iron-ajax id="resulthost" method="GET" headers$='{"Authorization":"JWT {{jwtToken.token}}"}' url="https://maas.nuqlis.com:8000/v2/obec/_studentcare_report/data/dl_{{form}}_{{year}}_{{hostid}}"
      content-type="application/json" handle-as="json" on-response="handleResponse">
    </iron-ajax>

    <!-- <iron-ajax 
      id="resultclass" 
      method="GET" 
      url$="https://maas.nuqlis.com:8000/v2/obec/_studentcare_report/data/dl_{{form}_{{year}}_{{hostid}}_{{class}}" 
      headers$='{"Authorization":"JWT {{jwtToken.token}}"}'
      content-type="application/json"
      handle-as ="json"
      on-response="handleResponse">
    </iron-ajax> -->

    <div class="layout vertical ">
      <div class="layout horizontal font-face ">
        <div class="flex-2 layout horizontal center-justified ">
          พฤติกรรมด้าน
        </div>
        <div class="flex-2 layout horizontal center-justified">
          มีจุดแข็ง
        </div>
        <div class="flex-2 layout horizontal center-justified">
          ไม่มีจุดแข็ง
        </div>
        <div class="flex-2 layout horizontal center-justified">
          กลุ่มปกติ
        </div>
        <div class="flex-2 layout horizontal center-justified">
          กลุ่มเสี่ยง
        </div>
        <div class="flex-2 layout horizontal center-justified">
          กลุ่มมีปัญหา
        </div>
      </div>
      <div class="layout horizontal">
        <div class="flex-2 layout horizontal row-content"></div>
        <div class="flex-2 layout horizontal row-content font-face">
          <div class="flex-1">ชาย</div>
          <div class="flex-1">หญิง</div>
          <div class="flex-1">รวม</div>
          <div class="flex-1">ร้อยละ</div>
        </div>
        <div class="flex-2 layout horizontal row-content font-face">
          <div class="flex-1">ชาย</div>
          <div class="flex-1">หญิง</div>
          <div class="flex-1">รวม</div>
          <div class="flex-1">ร้อยละ</div>
        </div>
        <div class="flex-2 layout horizontal row-content font-face">
          <div class="flex-1">ชาย</div>
          <div class="flex-1">หญิง</div>
          <div class="flex-1">รวม</div>
          <div class="flex-1">ร้อยละ</div>
        </div>
        <div class="flex-2 layout horizontal row-content font-face">
          <div class="flex-1">ชาย</div>
          <div class="flex-1">หญิง</div>
          <div class="flex-1">รวม</div>
          <div class="flex-1">ร้อยละ</div>
        </div>
        <div class="flex-2 layout horizontal row-content font-face">
          <div class="flex-1">ชาย</div>
          <div class="flex-1">หญิง</div>
          <div class="flex-1">รวม</div>
          <div class="flex-1">ร้อยละ</div>
        </div>
      </div>

      <paper-listbox class="flex" attr-for-selected="name" selected="{{form}}">
        <template is="dom-repeat" items="[[list]]">
          <paper-item class="flex line-style" name="{{item.type}}">
            <div class="layout horizontal flex font-face  row-content">
              <div class="flex-4">{{_formName(item.type)}}</div>
              <div class="flex-1">{{item.content.box1.boys}}</div>
              <div class="flex-1">{{item.content.box1.girls}}</div>
              <div class="flex-1">{{item.content.box1.sum}}</div>
              <div class="flex-1">{{item.content.box1.percent}}</div>
              <div class="flex-1">{{item.content.box2.boys}}</div>
              <div class="flex-1">{{item.content.box2.girls}}</div>
              <div class="flex-1">{{item.content.box2.sum}}</div>
              <div class="flex-1">{{item.content.box2.percent}}</div>
              <div class="flex-1">{{item.content.box3.boys}}</div>
              <div class="flex-1">{{item.content.box3.girls}}</div>
              <div class="flex-1">{{item.content.box3.sum}}</div>
              <div class="flex-1">{{item.content.box3.percent}}</div>
              <div class="flex-1">{{item.content.box4.boys}}</div>
              <div class="flex-1">{{item.content.box4.girls}}</div>
              <div class="flex-1">{{item.content.box4.sum}}</div>
              <div class="flex-1">{{item.content.box4.percent}}</div>
              <div class="flex-1">{{item.content.box5.boys}}</div>
              <div class="flex-1">{{item.content.box5.girls}}</div>
              <div class="flex-1">{{item.content.box5.sum}}</div>
              <div class="flex-1">{{item.content.box5.percent}}</div>
            </div>
          </paper-item>
        </template>
      </paper-listbox>
    </div>
  </template>

  <script>
    Polymer({
      is: 'dl2-host',
      behaviors: [
        Polymer.AppLocalizeBehavior,
        SummaryReportBehavior
      ],
      properties: {
        part: {
          type: Number,
          value: 0
        },
        year: {
          type: String,
          notify: true
        },
        hostid: {
          type: String,
          notify: true
        },
        form: {
          type: String,
          notify: true
        },
        _result: {
          type: Array,
          computed: '__computeResult(document.value.form_result)',
          value: function () {
            return [];
          }
        },
        invalidMessage: {
          type: String,
          notify: true,
          value: ''
        }
      },
      observers: [
        '_execute(jwtToken)',
      ],
      _formName: function (form) {
        var zz;
        var obj = {
          'emotion': 'ด้านอารมณ์',
          'behavior': 'ด้านความประพฤติ / เกเร',
          'behavior_active': 'ด้านพฤติกรรมไม่อยู่นิ่ง',
          'friend': 'ด้านความสัมพันธ์กับเพื่อน',
          'social': 'ด้านสัมพันธภาพทางสังคม',
        }
        var result = obj[form] ? obj[form] : form;
        return result;
      },
      // observers:[
      // '_execute(jwtToken.token,year,hostid,form)'
      // ],
      // _execute(token,year,hostid,form) {        
      //   if(token == null || year == null || hostid == null || form == null ) return;                  
      //   this.$.resulthost.generateRequest();
      //     // this.$.resultclass.generateRequest();
      //     // this.$.resultroom.generateRequest();
      // },
      _execute(token) {
        if (token == null || !token.token) return;
        this.$.resulthost.headers = {
          'Authorization': 'JWT ' + token.token
        }
        this.$.resulthost.generateRequest();
      },

      // _execute(token) {
      //   if(token == null || !token.token) return;  
      //   this.$.resulthost.headers = {
      //     'Authorization':'JWT '+token.token
      //   }
      //   this.$.resultlevel.generateRequest();
      // },
      // _execute(token) {
      //   if(token == null || !token.token) return;  
      //   this.$.resulthost.headers = {
      //     'Authorization':'JWT '+token.token
      //   }
      //   this.$.resultclass.generateRequest();
      // }

      handleResponse(e) {
        var doc = e.detail.response;
        var forms = [
          {
            type: "social", content: {
              box1: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box2: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box3: { boys: " ", girls: " ", sum: " ", percent: " " },
              box4: { boys: " ", girls: " ", sum: " ", percent: " " },
              box5: { boys: " ", girls: " ", sum: " ", percent: " " }
            }
          },
          {
            type: "emotion", content: {
              box1: { boys: " ", girls: " ", sum: " ", percent: " " },
              box2: { boys: " ", girls: " ", sum: " ", percent: " " },
              box3: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box4: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box5: { boys: 0, girls: 0, sum: 0, percent: 0 }
            }
          },
          {
            type: "behavior", content: {
              box1: { boys: " ", girls: " ", sum: " ", percent: " " },
              box2: { boys: " ", girls: " ", sum: " ", percent: " " },
              box3: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box4: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box5: { boys: 0, girls: 0, sum: 0, percent: 0 }
            }
          },
          {
            type: "behavior_active", content: {
              box1: { boys: " ", girls: " ", sum: " ", percent: " " },
              box2: { boys: " ", girls: " ", sum: " ", percent: " " },
              box3: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box4: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box5: { boys: 0, girls: 0, sum: 0, percent: 0 }
            }
          },
          {
            type: "friend", content: {
              box1: { boys: " ", girls: " ", sum: " ", percent: " " },
              box2: { boys: " ", girls: " ", sum: " ", percent: " " },
              box3: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box4: { boys: 0, girls: 0, sum: 0, percent: 0 },
              box5: { boys: 0, girls: 0, sum: 0, percent: 0 }
            }
          }
        ];
        var total ;
        for (var val in doc.value) {
          var cid = doc.value[val];
          for (var key in cid) {
            for (var form in forms) {
              if (key == "social") {
                if (val == "เด็กหญิง" || val == "นางสาว") {
                  if (Object.keys(cid[key]) == "ปกติ") {
                    forms[form].content.box1.girls++;
                    forms[form].content.box1.sum++;
                  } else {
                    forms[form].content.box2.girls++;
                    forms[form].content.box2.sum++;
                  }
                  total = forms[form].content.box1.sum+forms[form].content.box2.sum;
                  forms[form].content.box1.percent=Math.round((forms[form].content.box1.sum/total)*100);
                  forms[form].content.box2.percent=Math.round((forms[form].content.box2.sum/total)*100);
                  break;
                } else {
                  if (Object.keys(cid[key]) == "ปกติ") {
                    forms[form].content.box1.boys++;
                    forms[form].content.box1.sum++;
                  } else {
                    forms[form].content.box2.boys++;
                    forms[form].content.box2.sum++;
                  }
                  total = forms[form].content.box1.sum+forms[form].content.box2.sum;
                  forms[form].content.box1.percent=Math.round((forms[form].content.box1.sum/total)*100);
                  forms[form].content.box2.percent=Math.round((forms[form].content.box2.sum/total)*100);
                  break;
                }
              } else if (key == forms[form].type) {
                if (val == "เด็กหญิง" || val == "นางสาว") {
                  if (Object.keys(cid[key]) == "ปกติ") {
                    forms[form].content.box3.girls++;
                    forms[form].content.box3.sum++;
                  }else if(Object.keys(cid[key]) == "เสี่ยง"){
                    forms[form].content.box4.girls++;
                    forms[form].content.box4.sum++;
                  }else {
                    forms[form].content.box5.girls++;
                    forms[form].content.box5.sum++;
                  }
                  total = forms[form].content.box3.sum+forms[form].content.box4.sum+forms[form].content.box5.sum;
                  forms[form].content.box3.percent=Math.round((forms[form].content.box3.sum/total)*100);
                  forms[form].content.box4.percent=Math.round((forms[form].content.box4.sum/total)*100);
                  forms[form].content.box5.percent=Math.round((forms[form].content.box5.sum/total)*100);
                  break;
                } else {
                  if (Object.keys(cid[key]) == "ปกติ") {
                    forms[form].content.box3.boys++;
                    forms[form].content.box3.sum++;
                  } else if(Object.keys(cid[key]) == "เสี่ยง"){
                    forms[form].content.box4.boys++;
                    forms[form].content.box4.sum++;
                  }else {
                    forms[form].content.box5.boys++;
                    forms[form].content.box5.sum++;
                  }
                  total = forms[form].content.box3.sum+forms[form].content.box4.sum+forms[form].content.box5.sum;
                  forms[form].content.box3.percent=Math.round((forms[form].content.box3.sum/total)*100);
                  forms[form].content.box4.percent=Math.round((forms[form].content.box4.sum/total)*100);
                  forms[form].content.box5.percent=Math.round((forms[form].content.box5.sum/total)*100);
                  break;
                }
              }
            }
          }
        }
        this.set('list', forms);
      }
    });

  </script>
</dom-module>